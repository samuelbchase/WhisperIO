<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/foundation.css">
    <link rel="stylesheet" href="css/app.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <title>Whisper.io</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <meta name="google-signin-client_id" content="521002119514-k8kp3p42fpoq7ia5868k9s9e62bj87n3.apps.googleusercontent.com">

</head>
<script>
    //This global variable is used to determine that state of who the active friend is
    var ActiveFriend;
    //the global socket
    var socket;
    var userName; 
</script>
<body style="background:#073642">
        <div class="grid-x" style="background:#073642">
            <!--side bar -->
            <div id="sidebar" class="cell medium-3 large-1 small-6">
                <div>
                    <h3 class="horizcenter"> Friends </h3>
                    <ul class="list-group" id="users"></ul>
                </div>

                <ul id = "friendMenu" class="vertical menu">
                    <script>
                        //Gets all friends from the Database as requested from Server
                        //Display them as entries in the friends list
                        $(function () {
                            socket.on('FriendsList', function(msg){
                                for(var k in msg) {
                                    console.log("Creating Friend Bubble for: " + msg[k].Receiver);
                                    var x = document.createElement("LI");
                                    x.id = msg[k].Receiver;
                                    x.innerHTML = msg[k].Receiver;
                                    x.className += "friend";
									socket.emit('isOnline', msg[k].Receiver);
                                    x.onclick = function() {
                                        //loadmessages
                                        $(this).removeClass("flash");
                                        // on click removes notification toggle
                                        //Defines action for clicking on a friend in the list
                                        //Switches context to view the chatbox of that friend
                                        //& defines that friend as the active friend


                                        ActiveFriend = this.id;
                                        socket.emit('chathistory', userName, ActiveFriend);
                                        socket.on('messageHistory', (history) => {
                                            numItems = document.getElementById("chatbox" + ActiveFriend).children.length;
                                            if(numItems < history.length)
                                            {
                                                for(x in history) {
                                                    var div = document.createElement('div');
                                                    if(ActiveFriend == history[x].SentFrom) {
                                                        div.className = 'theirMessage';
                                                    }
                                                    else {
                                                        div.className = 'yourMessage';
                                                    }
                                                    div.textContent = history[x].Message;
                                                    document.getElementById("chatbox" + ActiveFriend).appendChild(div);
                                                }
                                            }
                                            
                                        });

                                        var ret = document.getElementsByClassName("chatbox");
                                        for (var i = 0; i < ret.length; i++) {
                                            document.getElementById(ret[i].id).style.display = "none"; //second console output
                                        }
                                        var ret2 = document.getElementsByClassName("activeFriend");
                                        for (i = 0; i < ret2.length; i++) {
                                            document.getElementById(ret2[i].id).classList.remove("activeFriend"); //second console output
                                        }
                                        this.className+=" activeFriend ";
                                        //console.log(ret);
                                        document.getElementById("chatbox" + this.id).style.display = "block";
                                    };
                                    document.getElementById("friendMenu").appendChild(x);
                                }
                            });
                        });
                    </script>
                </ul>
				<div id = "addFriendButton" class = "button" style = "background:#228B22">
					<div>
						<input type = "text" id = "newFriend"></input>
					</div>
					<button onclick = "addFriend()" style = "background:#adff2f;height:70px">Add Friend</button>
				</div>
                <div class="button expanded alert">
                    <button>
                        <button href="#" onclick="signOut()">Sign out</button>
                        <script>
                            function signOut() {
                                gapi.load('client:auth2', function() {
                                    gapi.auth2.init()
                                        .then(function() {
                                            gapi.auth2.getAuthInstance()
                                                .signOut()
                                        })
                                        .then(function() {
                                            alert("Thank you for using Whisper.io");
                                            console.log('Logging out user');
                                            console.log('User signed out.');
                                            // Kill login token
                                            sessionStorage.clear();
                                            window.location.href = "/";
                                        })
                                        .catch(function(err){
                                            console.log("Wokriiiinnnnnggg err: ", err);
                                        });
                                });
                            }
                        </script>
                    </button>
                </div>
            </div>
            <!--main chat interface-->
            <script>

                //When the document is ready make the chatboxes & open a socket to receive the friendslist
                $( document ).ready(function () {
                    socket.on('FriendsList', function(msg){
                        var first = false;
                        for(var k in msg) {
                            //For each friend make a unique chatbox
                            console.log("Creating Chatbox for: " + msg[k].Receiver);
                            var x = document.createElement("div");
                            x.style.display = "none";
                            x.className += "chatbox cell medium-12 large-11";
                            x.id = "chatbox" + msg[k].Receiver;

                            document.getElementById("main").appendChild(x);

                            if(first === false)
                            {
                                console.log("Clicking "+ msg[k].Receiver);
                                document.getElementById(msg[k].Receiver).click();
                                first = true;
                            }
                        }
                    });
                });
            </script>

            <div id="main"class="cell medium-12 large-11" style="height:50px;background:#002B36" >
            <form id="messenger">
                <div class="grid-container">
                    <div class="grid-x grid-padding-x">
                        <div class="large-6 cell">
                            <label>
                                <input id="messageSender" type="text" placeholder="Send a Message">
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        </div>

        <script>

            //TODO Add Send Button
            $('#messenger').keypress(function (e) {
                //When enter is pressed submit the current message
                if (e.which === 13) {
                    addMessage();
                    document.getElementById("messageSender").value = "";
                    return false;
                }
            });

            function addMessage()
            {
                //Get the message, and send that message on the socket to the server listener
                var message = $('#messageSender').val();
                socket.emit('chat message',ActiveFriend + "-" + message);
                var div = document.createElement('div');
                    div.className = 'yourMessage';
                    div.textContent = message;
                    document.getElementById("chatbox" + ActiveFriend).appendChild(div);
                    return 0;
            }


        </script>
          <!-- JQuery Script-->
        <script src="vendor/jquery.js"></script>
        <script src="vendor/foundation.js"></script>

        <script>
            $(document).foundation();
        </script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
        <script>

            var URL_SERVER = 'https://whisperio.club:3000';
            //var URL_SERVER = 'https://localhost:3000';
            var socket = io.connect(URL_SERVER);

            var whisperIOUser = sessionStorage.getItem("whisperIOUser") || 'defaultValue';
            console.log(whisperIOUser);
            userName = whisperIOUser;
            socket.emit('userNameSend', whisperIOUser);
            console.log(whisperIOUser);

            socket.on('chat message', function(msg){
                var indexOfSeparator = msg.indexOf('-');
                var userSentFrom = msg.slice(0,indexOfSeparator);
                var message = msg.slice(indexOfSeparator+1);
                var chatbox = document.getElementById("chatbox" + userSentFrom);

                //friends list element selector for notifiying users of new message
                var z = document.getElementById(userSentFrom);
                $(z).addClass("flash");

                var div = document.createElement('div');
                if(userSentFrom !== ActiveFriend)
                {
                    $(document.getElementById(userSentFrom)).addClass('flash');
                }
                console.log(document.getElementById(userSentFrom));

                div.className = 'theirMessage';
                div.textContent = message;
                console.log("Message Received!");

                chatbox.appendChild(div);
            });
        </script>
		
		<script>
			function addFriend() {
				console.log("adding friend");
				var addedFriend = $('#newFriend').val();
				var isAdded;
				socket.emit('addFriend', whisperIOUser, addedFriend);

				socket.on('addFriendResult', function(result){
                    if (result == 1)
                        alert(addedFriend + " has been added as a friend!");
                    else if (result == 0)
                        alert(addedFriend + " was not added as a friend: User does not exist");
                    else
                        alert(addedFriend + " was not added as a friend: User is already a friend");
                    window.location.href = "./main";
                });
			}
		</script>

        <script>
            socket.on('isOnlineResult', doStuff);

            function doStuff(status, friendName) {
                var onlineStatus;
                var x = document.getElementById(friendName);
                if (status == true)
                    x.className += " online ";

                else
                    x.className += " offline ";
            }
        </script>



</body>
</html>
